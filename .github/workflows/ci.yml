name: Mobile CI

on:
  push:
    branches:
      - main
      - develop
  pull_request:

env:
  EXPO_NO_TELEMETRY: "1"

jobs:
  lint_and_test:
    name: Lint and Jest
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Run ESLint
        run: npm run lint
      - name: Run unit tests
        run: npm test -- --ci --runInBand
      - name: Type-check
        run: npm run typecheck

  android_build:
    name: Android release build
    runs-on: ubuntu-latest
    needs: lint_and_test
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
      - name: Install dependencies
        run: npm ci
      - name: Expo prebuild (Android)
        run: npx expo prebuild --platform android --non-interactive --no-install
      - name: Grant execute permissions for Gradlew
        run: chmod +x android/gradlew
      - name: Assemble release APK
        run: cd android && ./gradlew :app:assembleRelease

  ios_build:
    name: iOS simulator build
    runs-on: macos-14
    needs: lint_and_test
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Install Watchman
        run: brew install watchman
      - name: Expo prebuild (iOS)
        run: npx expo prebuild --platform ios --non-interactive --no-install
      - name: Install CocoaPods dependencies
        run: cd ios && pod install
      - name: Build for simulator
        run: >-
          cd ios && xcodebuild \
          -workspace vibecode.xcworkspace \
          -scheme vibecode \
          -configuration Release \
          -sdk iphonesimulator \
          -destination 'platform=iOS Simulator,name=iPhone 15' \
          build
